"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(module, "exports", {
    enumerable: true,
    get: ()=>_default
});
const _util = require("@middy/util");
const mimePattern = /^application\/(.+\+)?json($|;.+)/;
const defaults = {
    reviver: undefined,
    disableContentTypeError: true
};
const httpJsonBodyParserMiddleware = (opts = {})=>{
    const options = {
        ...defaults,
        ...opts
    };
    const httpJsonBodyParserMiddlewareBefore = async (request)=>{
        const { headers , body  } = request.event;
        const contentType = headers['Content-Type'] ?? headers['content-type'];
        if (!mimePattern.test(contentType)) {
            if (options.disableContentTypeError) {
                return;
            }
            throw (0, _util.createError)(415, 'Unsupported Media Type', {
                cause: contentType
            });
        }
        try {
            const data = request.event.isBase64Encoded ? Buffer.from(body, 'base64').toString() : body;
            request.event.body = JSON.parse(data, options.reviver);
        } catch (cause) {
            throw (0, _util.createError)(415, 'Invalid or malformed JSON was provided', {
                cause
            });
        }
    };
    return {
        before: httpJsonBodyParserMiddlewareBefore
    };
};
const _default = httpJsonBodyParserMiddleware;

